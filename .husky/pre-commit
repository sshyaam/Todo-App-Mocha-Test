echo "üîç Running pre-commit checks..."

# Check npm package-lock.json consistency
echo "üì¶ Checking npm package consistency..."
if ! npm ls --depth=0 > /dev/null 2>&1; then
  echo "‚ùå Dependencies are out of sync"
  echo "   Run 'npm install' to fix this"
  exit 1
fi

# Run npm audit (check for vulnerabilities - warning only, doesn't block)
echo "üîí Running npm audit..."
npm audit --audit-level=high || {
  echo "‚ö†Ô∏è  npm audit found high/critical vulnerabilities (non-blocking)"
  echo "   Run 'npm audit fix' to attempt automatic fixes"
}

# Run Knip (find unused files, dependencies, exports, etc.)
echo "üîç Running Knip..."
npm run knip || {
  echo "‚ö†Ô∏è  Knip found unused code/dependencies (non-blocking)"
}

# Run ESLint
echo "üìù Running ESLint..."
npm run lint

# Run tests
echo "üß™ Running tests..."
npm run test

# Check test coverage (must be at least 90%)
echo "üìä Checking test coverage..."
COVERAGE_OUTPUT=$(npm run coverage 2>&1)
COVERAGE_PCT=$(echo "$COVERAGE_OUTPUT" | grep "All files" | awk '{print $4}' | sed 's/%//')

if [ -z "$COVERAGE_PCT" ]; then
  echo "‚ùå Could not determine coverage percentage"
  exit 1
fi

# Compare coverage (multiply by 10 to avoid decimal comparison issues)
COVERAGE_INT=$(echo "$COVERAGE_PCT" | awk '{printf "%.0f", $1 * 10}')
THRESHOLD_INT=900

if [ "$COVERAGE_INT" -lt "$THRESHOLD_INT" ]; then
  echo "‚ùå Test coverage is ${COVERAGE_PCT}%, but minimum required is 90%"
  echo "   Please add more tests to increase coverage"
else
  echo "‚úÖ Coverage check completed: ${COVERAGE_PCT}%"
fi

echo "‚úÖ Pre-commit checks passed!"
