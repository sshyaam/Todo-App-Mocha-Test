name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  install:
    name: Install Dependencies and then check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean up externals directory
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        if [ -d "externals" ]; then
          echo "ðŸ§¹ Removing externals directory to avoid caching large files"
          rm -rf externals
        fi

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Cache node_modules
      uses: actions/cache@v4
      id: node-modules-cache
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-

    - name: Install dependencies
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        npm ci

    - name: Check npm package consistency
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        npm ls --depth=0

    - name: Clean up externals directory before cache
      shell: bash
      if: always()
      run: |
        cd "${{ github.workspace }}"
        if [ -d "externals" ]; then
          echo "ðŸ§¹ Removing externals directory before post-job cache"
          rm -rf externals
        fi

  test:
    name: Run Tests and Checks
    runs-on: ubuntu-latest
    needs: install
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean up externals directory
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        if [ -d "externals" ]; then
          echo "ðŸ§¹ Removing externals directory to avoid caching large files"
          rm -rf externals
        fi

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Cache node_modules
      uses: actions/cache@v4
      id: node-modules-cache
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-

    - name: Install dependencies
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        npm ci

    - name: Use secret in workflow
      shell: bash
      env:
        MY_SECRET: ${{ secrets.MY_SECRET }}
      run: |
        cd "${{ github.workspace }}"
        # Secret is available as environment variable
        if [ -n "$MY_SECRET" ]; then
          echo "âœ… Secret is available (not showing value for security)"
          # Use the secret here (e.g., API calls, authentication, etc.)
          # Example: curl -H "Authorization: Bearer $MY_SECRET" https://api.example.com
        else
          echo "âš ï¸ Secret not found"
        fi

    - name: Run npm audit
      shell: bash
      continue-on-error: true
      run: |
        cd "${{ github.workspace }}"
        npm audit --audit-level=high

    - name: Run Knip
      shell: bash
      continue-on-error: true
      run: |
        cd "${{ github.workspace }}"
        npm run knip || {
          echo "Knip found unused code/dependencies (non blocking)"
        }

    - name: Run ESLint
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        npm run lint

    - name: Run tests
      shell: bash
      continue-on-error: false
      run: |
        cd "${{ github.workspace }}"
        npm run test

    - name: Generate test results
      shell: bash
      if: always()
      run: |
        cd "${{ github.workspace }}"
        # Create test results directory
        mkdir -p test-results
        
        # Run tests with JSON reporter and save output
        npm run test -- --reporter json > test-results/test-results.json 2>&1 || true
        
        # Also save the regular test output
        npm run test > test-results/test-output.txt 2>&1 || true

    - name: Check test coverage
      id: coverage
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        COVERAGE_OUTPUT=$(npm run coverage 2>&1)
        COVERAGE_PCT=$(echo "$COVERAGE_OUTPUT" | grep "All files" | awk '{print $4}' | sed 's/%//')
        
        if [ -z "$COVERAGE_PCT" ]; then
          echo "âŒ Could not determine coverage percentage"
          exit 1
        fi
        
        echo "coverage=$COVERAGE_PCT" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Test coverage: ${COVERAGE_PCT}%"
        
        # Compare coverage (multiply by 10 to avoid decimal comparison issues)
        COVERAGE_INT=$(echo "$COVERAGE_PCT" | awk '{printf "%.0f", $1 * 10}')
        THRESHOLD_INT=900
        
        if [ "$COVERAGE_INT" -lt "$THRESHOLD_INT" ]; then
          echo "âŒ Test coverage is ${COVERAGE_PCT}%, but minimum required is 90%"
          echo "   Please add more tests to increase coverage"
          exit 1
        else
          echo "âœ… Coverage check passed: ${COVERAGE_PCT}%"
        fi

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true
      with:
        name: coverage-report-${{ matrix.node-version }}
        path: coverage/
        retention-days: 7

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.node-version }}
        path: test-results/
        retention-days: 7

    - name: Clean up externals directory before cache
      shell: bash
      if: always()
      run: |
        cd "${{ github.workspace }}"
        if [ -d "externals" ]; then
          echo "ðŸ§¹ Removing externals directory before post-job cache"
          rm -rf externals
        fi

  check-branch:
    name: Check if main branch
    runs-on: ubuntu-latest
    outputs:
      is-main: ${{ steps.check.outputs.is-main }}
    steps:
      - name: Check if main branch
        id: check
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "is-main=true" >> $GITHUB_OUTPUT
          else
            echo "is-main=false" >> $GITHUB_OUTPUT
          fi

  preview-deploy:
    name: Preview Deployment
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Wrangler installation
        run: npx wrangler --version

      - name: Deploy Preview Worker
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --name little-shape-647c-preview-pr-${{ github.event.pull_request.number }}
        env:
          WRANGLER_SEND_METRICS: false

      - name: Get Preview URL
        id: preview-url
        run: |
          WORKER_NAME="little-shape-647c-preview-pr-${{ github.event.pull_request.number }}"
          # Cloudflare Workers URL format: https://<worker-name>.<account-subdomain>.workers.dev
          # We'll construct a URL that users can verify in Cloudflare dashboard
          PREVIEW_URL="https://${WORKER_NAME}.shyaamdps.workers.dev"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "worker-name=${WORKER_NAME}" >> $GITHUB_OUTPUT
          echo "Preview URL: ${PREVIEW_URL}"

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.preview-url.outputs.url }}';
            const prNumber = context.payload.pull_request.number;
            
            // Find existing preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );
            
            const workerName = '${{ steps.preview-url.outputs.worker-name }}';
            const commentBody = `## ðŸš€ Preview Deployment
            
            Your changes have been deployed to a preview Worker!
            
            **Worker Name:** \`${workerName}\`
            **Preview URL:** ${previewUrl}
            
            > **Note:** The preview URL may take a few minutes to become active. You can also find it in your [Cloudflare Workers dashboard](https://dash.cloudflare.com/).
            
            This preview will be automatically updated when you push new commits to this PR.
            The preview Worker will be deleted when this PR is closed or merged.
            
            ---
            *Deployed by GitHub Actions*`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  deploy:
    runs-on: ubuntu-latest
    needs: [test, check-branch]
    timeout-minutes: 10
    if: |
  (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
  (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Wrangler installation
        run: npx wrangler --version

      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: .

  cleanup-preview:
    name: Cleanup Preview Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Delete Preview Worker
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: delete --name little-shape-647c-preview-pr-${{ github.event.pull_request.number }}
        env:
          WRANGLER_SEND_METRICS: false

      - name: Comment PR about cleanup
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const workerName = `little-shape-647c-preview-pr-${prNumber}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸ§¹ Preview Cleanup
            
            The preview Worker \`${workerName}\` has been deleted.
            
            ---
            *Cleaned up by GitHub Actions*`
            });