name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  test:
    name: Run Tests and Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clean up externals directory
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        if [ -d "externals" ]; then
          echo "üßπ Removing externals directory to avoid caching large files"
          rm -rf externals
        fi

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Cache node_modules
      uses: actions/cache@v4
      id: node-modules-cache
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-

    - name: Install dependencies
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        npm ci

    - name: Run npm audit
      shell: bash
      continue-on-error: true
      run: |
        cd "${{ github.workspace }}"
        npm audit --audit-level=high

    - name: Run Knip
      shell: bash
      continue-on-error: true
      run: |
        cd "${{ github.workspace }}"
        npm run knip || {
          echo "Knip found unused code/dependencies (non blocking)"
        }

    - name: Run ESLint
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        npm run lint

    - name: Run tests
      shell: bash
      continue-on-error: false
      run: |
        cd "${{ github.workspace }}"
        npm run test

    - name: Generate test results
      shell: bash
      if: always()
      run: |
        cd "${{ github.workspace }}"
        # Create test results directory
        mkdir -p test-results
        
        # Run tests with JSON reporter and save output
        npm run test -- --reporter json > test-results/test-results.json 2>&1 || true
        
        # Also save the regular test output
        npm run test > test-results/test-output.txt 2>&1 || true

    - name: Check test coverage
      id: coverage
      shell: bash
      run: |
        cd "${{ github.workspace }}"
        COVERAGE_OUTPUT=$(npm run coverage 2>&1)
        COVERAGE_PCT=$(echo "$COVERAGE_OUTPUT" | grep "All files" | awk '{print $4}' | sed 's/%//')
        
        if [ -z "$COVERAGE_PCT" ]; then
          echo "‚ùå Could not determine coverage percentage"
          exit 1
        fi
        
        echo "coverage=$COVERAGE_PCT" >> $GITHUB_OUTPUT
        echo "üìä Test coverage: ${COVERAGE_PCT}%"
        
        # Compare coverage (multiply by 10 to avoid decimal comparison issues)
        COVERAGE_INT=$(echo "$COVERAGE_PCT" | awk '{printf "%.0f", $1 * 10}')
        THRESHOLD_INT=900
        
        if [ "$COVERAGE_INT" -lt "$THRESHOLD_INT" ]; then
          echo "‚ùå Test coverage is ${COVERAGE_PCT}%, but minimum required is 90%"
          echo "   Please add more tests to increase coverage"
          exit 1
        else
          echo "‚úÖ Coverage check passed: ${COVERAGE_PCT}%"
        fi

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true
      with:
        name: coverage-report-${{ matrix.node-version }}
        path: coverage/
        retention-days: 7

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.node-version }}
        path: test-results/
        retention-days: 7

    - name: Clean up externals directory before cache
      shell: bash
      if: always()
      run: |
        cd "${{ github.workspace }}"
        if [ -d "externals" ]; then
          echo "üßπ Removing externals directory before post-job cache"
          rm -rf externals
        fi

  preview-deploy:
    name: Preview Deployment
    runs-on: ubuntu-latest
    needs: test
    if: (github.event_name == 'pull_request' && github.event.action != 'closed')
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Wrangler installation
        run: npx wrangler --version

      - name: Get previous deployment ID
        id: previous-deployment
        continue-on-error: true
        run: |
          WORKER_NAME="little-shape-647c-preview"
          echo "üìã Getting current deployment ID for rollback..."
          
          # Try to get deployments list with JSON format first
          DEPLOYMENTS_JSON=$(npx wrangler deployments list --name "${WORKER_NAME}" --format json 2>&1 || echo "")
          
          if echo "$DEPLOYMENTS_JSON" | grep -q "\["; then
            # JSON format available - extract first deployment ID
            PREVIOUS_DEPLOYMENT=$(echo "$DEPLOYMENTS_JSON" | grep -oE '"[a-f0-9-]{36}"' | head -n1 | tr -d '"' || echo "")
            if [ -n "$PREVIOUS_DEPLOYMENT" ]; then
              echo "previous_deployment_id=${PREVIOUS_DEPLOYMENT}" >> $GITHUB_OUTPUT
              echo "‚úÖ Previous deployment ID: ${PREVIOUS_DEPLOYMENT}"
              # Save to file for rollback job
              echo "${PREVIOUS_DEPLOYMENT}" > previous_deployment_id.txt
              exit 0
            fi
          fi
          
          # Fallback: try text format
          DEPLOYMENTS_OUTPUT=$(npx wrangler deployments list --name "${WORKER_NAME}" 2>&1 || echo "")
          echo "Deployments output:"
          echo "$DEPLOYMENTS_OUTPUT"
          
          if [ -z "$DEPLOYMENTS_OUTPUT" ] || echo "$DEPLOYMENTS_OUTPUT" | grep -qi "no deployments\|not found\|error"; then
            echo "‚ö†Ô∏è No previous deployment found (this might be the first deployment)"
            echo "previous_deployment_id=" >> $GITHUB_OUTPUT
            echo "" > previous_deployment_id.txt
            exit 0
          fi
          
          # Try to extract deployment ID from text output
          # Format is usually: ID | Version | Created | Author
          PREVIOUS_DEPLOYMENT=$(echo "$DEPLOYMENTS_OUTPUT" | grep -E "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}" | head -n1 | awk '{print $1}' || echo "")
          
          # Alternative: look for UUID pattern anywhere in the output
          if [ -z "$PREVIOUS_DEPLOYMENT" ]; then
            PREVIOUS_DEPLOYMENT=$(echo "$DEPLOYMENTS_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -n1 || echo "")
          fi
          
          if [ -z "$PREVIOUS_DEPLOYMENT" ]; then
            echo "‚ö†Ô∏è Could not parse previous deployment ID from output"
            echo "previous_deployment_id=" >> $GITHUB_OUTPUT
            echo "" > previous_deployment_id.txt
          else
            echo "previous_deployment_id=${PREVIOUS_DEPLOYMENT}" >> $GITHUB_OUTPUT
            echo "‚úÖ Previous deployment ID: ${PREVIOUS_DEPLOYMENT}"
            echo "${PREVIOUS_DEPLOYMENT}" > previous_deployment_id.txt
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Upload previous deployment ID
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-previous-deployment-id
          path: previous_deployment_id.txt
          retention-days: 1

      - name: Deploy Preview Worker
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --name little-shape-647c-preview
        env:
          WRANGLER_SEND_METRICS: false

      - name: Get Preview URL
        id: preview-url
        run: |
          WORKER_NAME="little-shape-647c-preview"
          # Cloudflare Workers URL format: https://<worker-name>.<account-subdomain>.workers.dev
          # We'll construct a URL that users can verify in Cloudflare dashboard
          PREVIEW_URL="https://${WORKER_NAME}.shyaamdps.workers.dev"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "worker-name=${WORKER_NAME}" >> $GITHUB_OUTPUT
          echo "Preview URL: ${PREVIEW_URL}"

      - name: Wait for deployment to propagate
        run: |
          echo "‚è≥ Waiting 3 seconds for deployment to propagate..."
          sleep 3

      - name: Health check - Root endpoint
        id: health-check
        continue-on-error: true
        run: |
          PREVIEW_URL="${{ steps.preview-url.outputs.url }}"
          echo "üîç Checking health endpoint: ${PREVIEW_URL}/"
          
          MAX_RETRIES=3
          RETRY_DELAY=3
          HEALTH_STATUS="failed"
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            RESPONSE=$(curl -s -w "\n%{http_code}" "${PREVIEW_URL}/" || echo -e "\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              if echo "$BODY" | grep -q '"ok"'; then
                echo "‚úÖ Health check passed!"
                echo "Response: $BODY"
                HEALTH_STATUS="passed"
                break
              else
                echo "‚ö†Ô∏è Got 200 but response doesn't contain 'ok': $BODY"
              fi
            else
              echo "‚ùå Health check failed with HTTP $HTTP_CODE"
              echo "Response: $BODY"
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Retrying in ${RETRY_DELAY} seconds..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "health_status=${HEALTH_STATUS}" >> $GITHUB_OUTPUT
          if [ "$HEALTH_STATUS" != "passed" ]; then
            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Fail job if health check failed
        if: steps.health-check.outcome == 'failure'
        run: |
          echo "‚ùå Health check failed - failing job to trigger rollback"
          exit 1
          
      - name: Send Slack notification - Preview Deployment Success
        if: success()
        run: |
          PREVIEW_URL="${{ steps.preview-url.outputs.url }}"
          WORKER_NAME="${{ steps.preview-url.outputs.worker-name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üöÄ Preview Deployment Successful\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üöÄ Preview Deployment Successful\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*PR:* <${{ github.event.pull_request.html_url }}|#$PR_NUMBER: $PR_TITLE>\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Author:* $PR_AUTHOR\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Worker:* \`$WORKER_NAME\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Commit:* \`$COMMIT_SHORT\`\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Preview URL:* <$PREVIEW_URL|$PREVIEW_URL>\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Workflow:* <$WORKFLOW_RUN_URL|View Run>\"
                  }
                }
              ]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        continue-on-error: true

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        if: success() && github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.preview-url.outputs.url }}';
            const prNumber = context.payload.pull_request.number;
            
            // Find existing preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );
            
            const workerName = '${{ steps.preview-url.outputs.worker-name }}';
            const healthStatus = '${{ steps.health-check.outputs.health_status }}';
            
            let healthBadge = '‚úÖ';
            let healthMessage = 'Health check passed';
            if (healthStatus !== 'passed') {
              healthBadge = '‚ùå';
              healthMessage = 'Health check failed - rollback job will handle it';
            }
            
            const commentBody = `## üöÄ Preview Deployment
            
            Your changes have been deployed to the shared preview environment!
            
            **Worker Name:** \`${workerName}\`
            **Preview URL:** ${previewUrl}
            **Health Check:** ${healthBadge} ${healthMessage}
            
            > **Note:** This is a shared preview environment that is updated with each PR. The preview URL may take a few minutes to become active. You can also find it in your [Cloudflare Workers dashboard](https://dash.cloudflare.com/).
            
            This preview will be automatically updated when you push new commits to this PR.
            The preview environment is shared across all PRs and will not be deleted.
            
            ---
            *Deployed by GitHub Actions*`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  preview-rollback:
    name: Rollback Preview Deployment
    runs-on: ubuntu-latest
    needs: preview-deploy
    if: failure() && (github.event_name == 'pull_request' && github.event.action != 'closed')
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download previous deployment ID
        uses: actions/download-artifact@v4
        with:
          name: preview-previous-deployment-id
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Wrangler installation
        run: npx wrangler --version

      - name: Read previous deployment ID
        id: read-deployment-id
        run: |
          if [ -f previous_deployment_id.txt ]; then
            PREVIOUS_DEPLOYMENT=$(cat previous_deployment_id.txt | tr -d '\n' || echo "")
            if [ -n "$PREVIOUS_DEPLOYMENT" ]; then
              echo "previous_deployment_id=${PREVIOUS_DEPLOYMENT}" >> $GITHUB_OUTPUT
              echo "‚úÖ Found previous deployment ID: ${PREVIOUS_DEPLOYMENT}"
            else
              echo "previous_deployment_id=" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Previous deployment ID file is empty"
            fi
          else
            echo "previous_deployment_id=" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Previous deployment ID file not found"
          fi

      - name: Rollback Preview Deployment
        if: steps.read-deployment-id.outputs.previous_deployment_id != ''
        run: |
          PREVIOUS_DEPLOYMENT="${{ steps.read-deployment-id.outputs.previous_deployment_id }}"
          WORKER_NAME="little-shape-647c-preview"
          
          echo "üîÑ Rolling back preview deployment to: ${PREVIOUS_DEPLOYMENT}"
          echo "Worker Name: ${WORKER_NAME}"
          
          # Perform rollback
          npx wrangler rollback "${PREVIOUS_DEPLOYMENT}" --name "${WORKER_NAME}" || {
            echo "‚ùå Rollback command failed!"
            echo "Attempting alternative rollback method..."
            # Try without --name flag
            npx wrangler rollback "${PREVIOUS_DEPLOYMENT}" || {
              echo "‚ùå Alternative rollback also failed!"
              exit 1
            }
          }
          echo "‚úÖ Successfully rolled back to deployment: ${PREVIOUS_DEPLOYMENT}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WRANGLER_SEND_METRICS: false

      - name: Send Slack notification - Preview Rollback
        if: steps.read-deployment-id.outputs.previous_deployment_id != ''
        run: |
          PREVIOUS_DEPLOYMENT="${{ steps.read-deployment-id.outputs.previous_deployment_id }}"
          WORKER_NAME="little-shape-647c-preview"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"‚ö†Ô∏è Preview Deployment Rolled Back\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"‚ö†Ô∏è Preview Deployment Rolled Back\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*PR:* <${{ github.event.pull_request.html_url }}|#$PR_NUMBER: $PR_TITLE>\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Author:* $PR_AUTHOR\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Worker:* \`$WORKER_NAME\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Rolled back to:* \`$PREVIOUS_DEPLOYMENT\`\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Reason:* Health check failed after deployment. Automatically rolled back to previous working version.\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Workflow:* <$WORKFLOW_RUN_URL|View Run>\"
                  }
                }
              ]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        continue-on-error: true

      - name: Comment PR about rollback
        if: steps.read-deployment-id.outputs.previous_deployment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const previousDeployment = '${{ steps.read-deployment-id.outputs.previous_deployment_id }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## üîÑ Preview Rollback
            
            ‚ö†Ô∏è **Deployment failed health check and was automatically rolled back.**
            
            **Rolled back to deployment ID:** \`${previousDeployment}\`
            
            The preview environment has been restored to the previous working version.
            
            ---
            *Rolled back by GitHub Actions*`
            });

  deploy:
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Wrangler installation
        run: npx wrangler --version

      - name: Get previous deployment ID
        id: previous-deployment
        continue-on-error: true
        run: |
          WORKER_NAME="little-shape-647c"
          echo "üìã Getting current deployment ID for rollback..."
          
          # Try to get deployments list with JSON format first
          DEPLOYMENTS_JSON=$(npx wrangler deployments list --name "${WORKER_NAME}" --format json 2>&1 || echo "")
          
          if echo "$DEPLOYMENTS_JSON" | grep -q "\["; then
            # JSON format available - extract first deployment ID
            PREVIOUS_DEPLOYMENT=$(echo "$DEPLOYMENTS_JSON" | grep -oE '"[a-f0-9-]{36}"' | head -n1 | tr -d '"' || echo "")
            if [ -n "$PREVIOUS_DEPLOYMENT" ]; then
              echo "previous_deployment_id=${PREVIOUS_DEPLOYMENT}" >> $GITHUB_OUTPUT
              echo "‚úÖ Previous deployment ID: ${PREVIOUS_DEPLOYMENT}"
              # Save to file for rollback job
              echo "${PREVIOUS_DEPLOYMENT}" > previous_deployment_id.txt
              exit 0
            fi
          fi
          
          # Fallback: try text format
          DEPLOYMENTS_OUTPUT=$(npx wrangler deployments list --name "${WORKER_NAME}" 2>&1 || echo "")
          echo "Deployments output:"
          echo "$DEPLOYMENTS_OUTPUT"
          
          if [ -z "$DEPLOYMENTS_OUTPUT" ] || echo "$DEPLOYMENTS_OUTPUT" | grep -qi "no deployments\|not found\|error"; then
            echo "‚ö†Ô∏è No previous deployment found (this might be the first deployment)"
            echo "previous_deployment_id=" >> $GITHUB_OUTPUT
            echo "" > previous_deployment_id.txt
            exit 0
          fi
          
          # Try to extract deployment ID from text output
          # Format is usually: ID | Version | Created | Author
          PREVIOUS_DEPLOYMENT=$(echo "$DEPLOYMENTS_OUTPUT" | grep -E "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}" | head -n1 | awk '{print $1}' || echo "")
          
          # Alternative: look for UUID pattern anywhere in the output
          if [ -z "$PREVIOUS_DEPLOYMENT" ]; then
            PREVIOUS_DEPLOYMENT=$(echo "$DEPLOYMENTS_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -n1 || echo "")
          fi
          
          if [ -z "$PREVIOUS_DEPLOYMENT" ]; then
            echo "‚ö†Ô∏è Could not parse previous deployment ID from output"
            echo "previous_deployment_id=" >> $GITHUB_OUTPUT
            echo "" > previous_deployment_id.txt
          else
            echo "previous_deployment_id=${PREVIOUS_DEPLOYMENT}" >> $GITHUB_OUTPUT
            echo "‚úÖ Previous deployment ID: ${PREVIOUS_DEPLOYMENT}"
            echo "${PREVIOUS_DEPLOYMENT}" > previous_deployment_id.txt
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Upload previous deployment ID
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-previous-deployment-id
          path: previous_deployment_id.txt
          retention-days: 1

      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: .

      - name: Get Production URL
        id: production-url
        run: |
          WORKER_NAME="little-shape-647c"
          # Cloudflare Workers URL format: https://<worker-name>.<account-subdomain>.workers.dev
          PRODUCTION_URL="https://${WORKER_NAME}.shyaamdps.workers.dev"
          echo "url=${PRODUCTION_URL}" >> $GITHUB_OUTPUT
          echo "worker-name=${WORKER_NAME}" >> $GITHUB_OUTPUT
          echo "Production URL: ${PRODUCTION_URL}"

      - name: Wait for deployment to propagate
        run: |
          echo "‚è≥ Waiting 3 seconds for deployment to propagate..."
          sleep 3

      - name: Health check - Root endpoint
        id: health-check
        continue-on-error: true
        run: |
          PRODUCTION_URL="${{ steps.production-url.outputs.url }}"
          echo "üîç Checking health endpoint: ${PRODUCTION_URL}/"
          
          MAX_RETRIES=3
          RETRY_DELAY=3
          HEALTH_STATUS="failed"
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            RESPONSE=$(curl -s -w "\n%{http_code}" "${PRODUCTION_URL}/" || echo -e "\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              if echo "$BODY" | grep -q '"ok"'; then
                echo "‚úÖ Health check passed!"
                echo "Response: $BODY"
                HEALTH_STATUS="passed"
                break
              else
                echo "‚ö†Ô∏è Got 200 but response doesn't contain 'ok': $BODY"
              fi
            else
              echo "‚ùå Health check failed with HTTP $HTTP_CODE"
              echo "Response: $BODY"
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Retrying in ${RETRY_DELAY} seconds..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "health_status=${HEALTH_STATUS}" >> $GITHUB_OUTPUT
          if [ "$HEALTH_STATUS" != "passed" ]; then
            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Fail job if health check failed
        if: steps.health-check.outcome == 'failure'
        run: |
          echo "‚ùå Health check failed - failing job to trigger rollback"
          exit 1

      - name: Send Slack notification - Production Deployment Success
        if: success()
        run: |
          PRODUCTION_URL="${{ steps.production-url.outputs.url }}"
          WORKER_NAME="${{ steps.production-url.outputs.worker-name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref_name }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"‚úÖ Production Deployment Successful\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"‚úÖ Production Deployment Successful\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:* \`$BRANCH\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Worker:* \`$WORKER_NAME\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Commit:* \`$COMMIT_SHORT\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Author:* $COMMIT_AUTHOR\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Production URL:* <$PRODUCTION_URL|$PRODUCTION_URL>\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Commit Message:* \`$COMMIT_MESSAGE\`\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Workflow:* <$WORKFLOW_RUN_URL|View Run>\"
                  }
                }
              ]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        continue-on-error: true

      - name: Deployment summary
        if: success()
        run: |
          PRODUCTION_URL="${{ steps.production-url.outputs.url }}"
          WORKER_NAME="${{ steps.production-url.outputs.worker-name }}"
          HEALTH_STATUS="${{ steps.health-check.outputs.health_status }}"
          
          echo "## üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker Name:** \`${WORKER_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Production URL:** ${PRODUCTION_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üåê **Worker is live and healthy!**" >> $GITHUB_STEP_SUMMARY

  production-rollback:
    name: Rollback Production Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download previous deployment ID
        uses: actions/download-artifact@v4
        with:
          name: production-previous-deployment-id
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Wrangler installation
        run: npx wrangler --version

      - name: Read previous deployment ID
        id: read-deployment-id
        run: |
          if [ -f previous_deployment_id.txt ]; then
            PREVIOUS_DEPLOYMENT=$(cat previous_deployment_id.txt | tr -d '\n' || echo "")
            if [ -n "$PREVIOUS_DEPLOYMENT" ]; then
              echo "previous_deployment_id=${PREVIOUS_DEPLOYMENT}" >> $GITHUB_OUTPUT
              echo "‚úÖ Found previous deployment ID: ${PREVIOUS_DEPLOYMENT}"
            else
              echo "previous_deployment_id=" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Previous deployment ID file is empty"
            fi
          else
            echo "previous_deployment_id=" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Previous deployment ID file not found"
          fi

      - name: Rollback Production Deployment
        if: steps.read-deployment-id.outputs.previous_deployment_id != ''
        run: |
          PREVIOUS_DEPLOYMENT="${{ steps.read-deployment-id.outputs.previous_deployment_id }}"
          WORKER_NAME="little-shape-647c"
          
          echo "üîÑ Rolling back production deployment to: ${PREVIOUS_DEPLOYMENT}"
          echo "Worker Name: ${WORKER_NAME}"
          
          # Perform rollback
          npx wrangler rollback "${PREVIOUS_DEPLOYMENT}" --name "${WORKER_NAME}" || {
            echo "‚ùå Rollback command failed!"
            echo "Attempting alternative rollback method..."
            # Try without --name flag (uses wrangler.jsonc)
            npx wrangler rollback "${PREVIOUS_DEPLOYMENT}" || {
              echo "‚ùå Alternative rollback also failed!"
              exit 1
            }
          }
          echo "‚úÖ Successfully rolled back to deployment: ${PREVIOUS_DEPLOYMENT}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WRANGLER_SEND_METRICS: false

      - name: Send Slack notification - Production Rollback
        if: steps.read-deployment-id.outputs.previous_deployment_id != ''
        run: |
          PREVIOUS_DEPLOYMENT="${{ steps.read-deployment-id.outputs.previous_deployment_id }}"
          WORKER_NAME="little-shape-647c"
          PRODUCTION_URL="https://${WORKER_NAME}.shyaamdps.workers.dev"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref_name }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üö® Production Deployment Rolled Back\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üö® Production Deployment Rolled Back\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Branch:* \`$BRANCH\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Worker:* \`$WORKER_NAME\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Commit:* \`$COMMIT_SHORT\`\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Author:* $COMMIT_AUTHOR\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Production URL:* <$PRODUCTION_URL|$PRODUCTION_URL>\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Rolled back to:* \`$PREVIOUS_DEPLOYMENT\`\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Reason:* Health check failed after deployment. Automatically rolled back to previous working version.\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Workflow:* <$WORKFLOW_RUN_URL|View Run>\"
                  }
                }
              ]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        continue-on-error: true

      - name: Create rollback summary
        if: steps.read-deployment-id.outputs.previous_deployment_id != ''
        run: |
          PREVIOUS_DEPLOYMENT="${{ steps.read-deployment-id.outputs.previous_deployment_id }}"
          WORKER_NAME="little-shape-647c"
          PRODUCTION_URL="https://${WORKER_NAME}.shyaamdps.workers.dev"
          
          echo "## ‚ö†Ô∏è Production Deployment - Rolled Back" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ùå **Deployment failed health check and was automatically rolled back.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker Name:** \`${WORKER_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Production URL:** ${PRODUCTION_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Rolled back to:** \`${PREVIOUS_DEPLOYMENT}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîÑ **Worker has been rolled back to the previous working deployment.**" >> $GITHUB_STEP_SUMMARY
