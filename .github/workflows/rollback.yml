name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to rollback to'
        required: true
        type: string

permissions:
  contents: read

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit exists
        id: validate-commit
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          if ! git cat-file -e "$COMMIT_SHA^{commit}" 2>/dev/null; then
            echo "âŒ Commit $COMMIT_SHA not found in repository"
            exit 1
          fi
          echo "âœ… Commit $COMMIT_SHA found"
          echo "commit=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Checkout rollback commit
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          echo "Checking out commit: $COMMIT_SHA"
          git checkout "$COMMIT_SHA"

      - name: Show commit info
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          echo "ğŸ“‹ Rolling back to commit: $COMMIT_SHA"
          echo "ğŸ“ Commit message:"
          git log -1 --format="%B" "$COMMIT_SHA"
          echo ""
          echo "ğŸ‘¤ Author: $(git log -1 --format='%an <%ae>' "$COMMIT_SHA")"
          echo "ğŸ“… Date: $(git log -1 --format='%ad' --date=format:'%Y-%m-%d %H:%M:%S' "$COMMIT_SHA")"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Wrangler installation
        run: npx wrangler --version

      - name: Rollback Deployment
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: .

      - name: Create rollback summary
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          COMMIT_MSG=$(git log -1 --format="%s" "$COMMIT_SHA")
          COMMIT_AUTHOR=$(git log -1 --format="%an" "$COMMIT_SHA")
          COMMIT_DATE=$(git log -1 --format="%ad" --date=format:'%Y-%m-%d %H:%M:%S' "$COMMIT_SHA")
          
          echo "## ğŸ”„ Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Successfully rolled back to:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Message:** $COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** $COMMIT_AUTHOR" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $COMMIT_DATE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ Worker has been deployed with the rollback version." >> $GITHUB_STEP_SUMMARY

